/**
 * Font rendering module
 * Optimized for batch pixel writes
 */

//% weight=18
namespace Font {
    // Font12: 7 pixels wide, 12 pixels tall
    export const CHAR_WIDTH = 7
    export const CHAR_HEIGHT = 12

    // Font bitmap data (ASCII 32-126)
    // Each character is 12 bytes (one byte per row)
    const fontData: number[] = [
        // @0 ' ' (space)
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        // @12 '!'
        0x00, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00,
        // @24 '"'
        0x00, 0x6C, 0x48, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        // @36 '#'
        0x00, 0x14, 0x14, 0x28, 0x7C, 0x28, 0x7C, 0x28, 0x50, 0x50, 0x00, 0x00,
        // @48 '$'
        0x00, 0x10, 0x38, 0x40, 0x40, 0x38, 0x48, 0x70, 0x10, 0x10, 0x00, 0x00,
        // @60 '%'
        0x00, 0x20, 0x50, 0x20, 0x0C, 0x70, 0x08, 0x14, 0x08, 0x00, 0x00, 0x00,
        // @72 '&'
        0x00, 0x00, 0x00, 0x18, 0x20, 0x20, 0x54, 0x48, 0x34, 0x00, 0x00, 0x00,
        // @84 '''
        0x00, 0x10, 0x10, 0x10, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        // @96 '('
        0x00, 0x08, 0x08, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x08, 0x08, 0x00,
        // @108 ')'
        0x00, 0x20, 0x20, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x20, 0x20, 0x00,
        // @120 '*'
        0x00, 0x10, 0x7C, 0x10, 0x28, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        // @132 '+'
        0x00, 0x00, 0x10, 0x10, 0x10, 0xFE, 0x10, 0x10, 0x10, 0x00, 0x00, 0x00,
        // @144 ','
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x18, 0x10, 0x30, 0x20, 0x00,
        // @156 '-'
        0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        // @168 '.'
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x30, 0x30, 0x00, 0x00, 0x00,
        // @180 '/'
        0x00, 0x04, 0x04, 0x08, 0x08, 0x10, 0x10, 0x20, 0x20, 0x40, 0x00, 0x00,
        // @192 '0'
        0x00, 0x38, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x38, 0x00, 0x00, 0x00,
        // @204 '1'
        0x00, 0x30, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x7C, 0x00, 0x00, 0x00,
        // @216 '2'
        0x00, 0x38, 0x44, 0x04, 0x08, 0x10, 0x20, 0x44, 0x7C, 0x00, 0x00, 0x00,
        // @228 '3'
        0x00, 0x38, 0x44, 0x04, 0x18, 0x04, 0x04, 0x44, 0x38, 0x00, 0x00, 0x00,
        // @240 '4'
        0x00, 0x0C, 0x14, 0x14, 0x24, 0x44, 0x7E, 0x04, 0x0E, 0x00, 0x00, 0x00,
        // @252 '5'
        0x00, 0x3C, 0x20, 0x20, 0x38, 0x04, 0x04, 0x44, 0x38, 0x00, 0x00, 0x00,
        // @264 '6'
        0x00, 0x1C, 0x20, 0x40, 0x78, 0x44, 0x44, 0x44, 0x38, 0x00, 0x00, 0x00,
        // @276 '7'
        0x00, 0x7C, 0x44, 0x04, 0x08, 0x08, 0x08, 0x10, 0x10, 0x00, 0x00, 0x00,
        // @288 '8'
        0x00, 0x38, 0x44, 0x44, 0x38, 0x44, 0x44, 0x44, 0x38, 0x00, 0x00, 0x00,
        // @300 '9'
        0x00, 0x38, 0x44, 0x44, 0x44, 0x3C, 0x04, 0x08, 0x70, 0x00, 0x00, 0x00,
        // @312 ':'
        0x00, 0x00, 0x00, 0x30, 0x30, 0x00, 0x00, 0x30, 0x30, 0x00, 0x00, 0x00,
        // @324 ';'
        0x00, 0x00, 0x00, 0x18, 0x18, 0x00, 0x00, 0x18, 0x30, 0x20, 0x00, 0x00,
        // @336 '<'
        0x00, 0x00, 0x0C, 0x10, 0x60, 0x80, 0x60, 0x10, 0x0C, 0x00, 0x00, 0x00,
        // @348 '='
        0x00, 0x00, 0x00, 0x00, 0x7C, 0x00, 0x7C, 0x00, 0x00, 0x00, 0x00, 0x00,
        // @360 '>'
        0x00, 0x00, 0xC0, 0x20, 0x18, 0x04, 0x18, 0x20, 0xC0, 0x00, 0x00, 0x00,
        // @372 '?'
        0x00, 0x00, 0x18, 0x24, 0x04, 0x08, 0x10, 0x00, 0x30, 0x00, 0x00, 0x00,
        // @384 '@'
        0x38, 0x44, 0x44, 0x4C, 0x54, 0x54, 0x4C, 0x40, 0x44, 0x38, 0x00, 0x00,
        // @396 'A'
        0x00, 0x30, 0x10, 0x28, 0x28, 0x28, 0x7C, 0x44, 0xEE, 0x00, 0x00, 0x00,
        // @408 'B'
        0x00, 0xF8, 0x44, 0x44, 0x78, 0x44, 0x44, 0x44, 0xF8, 0x00, 0x00, 0x00,
        // @420 'C'
        0x00, 0x3C, 0x44, 0x40, 0x40, 0x40, 0x40, 0x44, 0x38, 0x00, 0x00, 0x00,
        // @432 'D'
        0x00, 0xF0, 0x48, 0x44, 0x44, 0x44, 0x44, 0x48, 0xF0, 0x00, 0x00, 0x00,
        // @444 'E'
        0x00, 0xFC, 0x44, 0x50, 0x70, 0x50, 0x40, 0x44, 0xFC, 0x00, 0x00, 0x00,
        // @456 'F'
        0x00, 0x7E, 0x22, 0x28, 0x38, 0x28, 0x20, 0x20, 0x70, 0x00, 0x00, 0x00,
        // @468 'G'
        0x00, 0x3C, 0x44, 0x40, 0x40, 0x4E, 0x44, 0x44, 0x38, 0x00, 0x00, 0x00,
        // @480 'H'
        0x00, 0xEE, 0x44, 0x44, 0x7C, 0x44, 0x44, 0x44, 0xEE, 0x00, 0x00, 0x00,
        // @492 'I'
        0x00, 0x7C, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x7C, 0x00, 0x00, 0x00,
        // @504 'J'
        0x00, 0x3C, 0x08, 0x08, 0x08, 0x48, 0x48, 0x48, 0x30, 0x00, 0x00, 0x00,
        // @516 'K'
        0x00, 0xEE, 0x44, 0x48, 0x50, 0x70, 0x48, 0x44, 0xE6, 0x00, 0x00, 0x00,
        // @528 'L'
        0x00, 0x70, 0x20, 0x20, 0x20, 0x20, 0x24, 0x24, 0x7C, 0x00, 0x00, 0x00,
        // @540 'M'
        0x00, 0xEE, 0x6C, 0x6C, 0x54, 0x54, 0x44, 0x44, 0xEE, 0x00, 0x00, 0x00,
        // @552 'N'
        0x00, 0xEE, 0x64, 0x64, 0x54, 0x54, 0x54, 0x4C, 0xEC, 0x00, 0x00, 0x00,
        // @564 'O'
        0x00, 0x38, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x38, 0x00, 0x00, 0x00,
        // @576 'P'
        0x00, 0x78, 0x24, 0x24, 0x24, 0x38, 0x20, 0x20, 0x70, 0x00, 0x00, 0x00,
        // @588 'Q'
        0x00, 0x38, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x38, 0x1C, 0x00, 0x00,
        // @600 'R'
        0x00, 0xF8, 0x44, 0x44, 0x44, 0x78, 0x48, 0x44, 0xE2, 0x00, 0x00, 0x00,
        // @612 'S'
        0x00, 0x34, 0x4C, 0x40, 0x38, 0x04, 0x04, 0x64, 0x58, 0x00, 0x00, 0x00,
        // @624 'T'
        0x00, 0xFE, 0x92, 0x10, 0x10, 0x10, 0x10, 0x10, 0x38, 0x00, 0x00, 0x00,
        // @636 'U'
        0x00, 0xEE, 0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x38, 0x00, 0x00, 0x00,
        // @648 'V'
        0x00, 0xEE, 0x44, 0x44, 0x28, 0x28, 0x28, 0x10, 0x10, 0x00, 0x00, 0x00,
        // @660 'W'
        0x00, 0xEE, 0x44, 0x44, 0x54, 0x54, 0x54, 0x54, 0x28, 0x00, 0x00, 0x00,
        // @672 'X'
        0x00, 0xC6, 0x44, 0x28, 0x10, 0x10, 0x28, 0x44, 0xC6, 0x00, 0x00, 0x00,
        // @684 'Y'
        0x00, 0xEE, 0x44, 0x28, 0x28, 0x10, 0x10, 0x10, 0x38, 0x00, 0x00, 0x00,
        // @696 'Z'
        0x00, 0x7C, 0x44, 0x08, 0x10, 0x10, 0x20, 0x44, 0x7C, 0x00, 0x00, 0x00,
        // @708 '['
        0x00, 0x38, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x38, 0x00,
        // @720 '\'
        0x00, 0x40, 0x20, 0x20, 0x20, 0x10, 0x10, 0x08, 0x08, 0x08, 0x00, 0x00,
        // @732 ']'
        0x00, 0x38, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x38, 0x00,
        // @744 '^'
        0x00, 0x10, 0x10, 0x28, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        // @756 '_'
        0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0xFE,
        // @768 '`'
        0x00, 0x10, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
        // @780 'a'
        0x00, 0x00, 0x00, 0x38, 0x44, 0x3C, 0x44, 0x44, 0x3E, 0x00, 0x00, 0x00,
        // @792 'b'
        0x00, 0xC0, 0x40, 0x58, 0x64, 0x44, 0x44, 0x44, 0xF8, 0x00, 0x00, 0x00,
        // @804 'c'
        0x00, 0x00, 0x00, 0x3C, 0x44, 0x40, 0x40, 0x44, 0x38, 0x00, 0x00, 0x00,
        // @816 'd'
        0x00, 0x0C, 0x04, 0x34, 0x4C, 0x44, 0x44, 0x44, 0x3E, 0x00, 0x00, 0x00,
        // @828 'e'
        0x00, 0x00, 0x00, 0x38, 0x44, 0x7C, 0x40, 0x40, 0x3C, 0x00, 0x00, 0x00,
        // @840 'f'
        0x00, 0x1C, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x20, 0x7C, 0x00, 0x00, 0x00,
        // @852 'g'
        0x00, 0x00, 0x00, 0x36, 0x4C, 0x44, 0x44, 0x44, 0x3C, 0x04, 0x38, 0x00,
        // @864 'h'
        0x00, 0xC0, 0x40, 0x58, 0x64, 0x44, 0x44, 0x44, 0xEE, 0x00, 0x00, 0x00,
        // @876 'i'
        0x00, 0x10, 0x00, 0x70, 0x10, 0x10, 0x10, 0x10, 0x7C, 0x00, 0x00, 0x00,
        // @888 'j'
        0x00, 0x10, 0x00, 0x78, 0x08, 0x08, 0x08, 0x08, 0x08, 0x08, 0x70, 0x00,
        // @900 'k'
        0x00, 0xC0, 0x40, 0x5C, 0x48, 0x70, 0x50, 0x48, 0xDC, 0x00, 0x00, 0x00,
        // @912 'l'
        0x00, 0x30, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x7C, 0x00, 0x00, 0x00,
        // @924 'm'
        0x00, 0x00, 0x00, 0xE8, 0x54, 0x54, 0x54, 0x54, 0xFE, 0x00, 0x00, 0x00,
        // @936 'n'
        0x00, 0x00, 0x00, 0xD8, 0x64, 0x44, 0x44, 0x44, 0xEE, 0x00, 0x00, 0x00,
        // @948 'o'
        0x00, 0x00, 0x00, 0x38, 0x44, 0x44, 0x44, 0x44, 0x38, 0x00, 0x00, 0x00,
        // @960 'p'
        0x00, 0x00, 0x00, 0xD8, 0x64, 0x44, 0x44, 0x44, 0x78, 0x40, 0xE0, 0x00,
        // @972 'q'
        0x00, 0x00, 0x00, 0x36, 0x4C, 0x44, 0x44, 0x44, 0x3C, 0x04, 0x0E, 0x00,
        // @984 'r'
        0x00, 0x00, 0x00, 0x6C, 0x30, 0x20, 0x20, 0x20, 0x7C, 0x00, 0x00, 0x00,
        // @996 's'
        0x00, 0x00, 0x00, 0x3C, 0x44, 0x38, 0x04, 0x44, 0x78, 0x00, 0x00, 0x00,
        // @1008 't'
        0x00, 0x00, 0x20, 0x7C, 0x20, 0x20, 0x20, 0x22, 0x1C, 0x00, 0x00, 0x00,
        // @1020 'u'
        0x00, 0x00, 0x00, 0xCC, 0x44, 0x44, 0x44, 0x4C, 0x36, 0x00, 0x00, 0x00,
        // @1032 'v'
        0x00, 0x00, 0x00, 0xEE, 0x44, 0x44, 0x28, 0x28, 0x10, 0x00, 0x00, 0x00,
        // @1044 'w'
        0x00, 0x00, 0x00, 0xEE, 0x44, 0x54, 0x54, 0x54, 0x28, 0x00, 0x00, 0x00,
        // @1056 'x'
        0x00, 0x00, 0x00, 0xCC, 0x48, 0x30, 0x30, 0x48, 0xCC, 0x00, 0x00, 0x00,
        // @1068 'y'
        0x00, 0x00, 0x00, 0xEE, 0x44, 0x24, 0x28, 0x18, 0x10, 0x10, 0x78, 0x00,
        // @1080 'z'
        0x00, 0x00, 0x00, 0x7C, 0x48, 0x10, 0x20, 0x44, 0x7C, 0x00, 0x00, 0x00,
        // @1092 '{'
        0x00, 0x08, 0x10, 0x10, 0x10, 0x10, 0x20, 0x10, 0x10, 0x10, 0x08, 0x00,
        // @1104 '|'
        0x00, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00, 0x00,
        // @1116 '}'
        0x00, 0x20, 0x10, 0x10, 0x10, 0x10, 0x08, 0x10, 0x10, 0x10, 0x20, 0x00,
        // @1128 '~'
        0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x58, 0x00, 0x00, 0x00, 0x00, 0x00,
    ]

    /**
     * Get font data for a character
     */
    export function getCharData(char: string): number[] {
        const code = char.charCodeAt(0)
        // ASCII 32 (space) to 126 (~)
        if (code < 32 || code > 126) {
            return fontData.slice(0, CHAR_HEIGHT)  // Return space for unknown
        }
        const offset = (code - 32) * CHAR_HEIGHT
        return fontData.slice(offset, offset + CHAR_HEIGHT)
    }

    /**
     * Draw a single character at position (optimized)
     */
    export function drawChar(x: number, y: number, char: string, color: number, bgColor: number = -1): void {
        const charData = getCharData(char)

        for (let row = 0; row < CHAR_HEIGHT; row++) {
            const rowData = charData[row]
            const py = y + row
            if (py < 0 || py >= LCD_HEIGHT) continue

            // If we have a background color, draw the entire row efficiently
            if (bgColor >= 0) {
                // Use stream mode for the entire character row
                const startX = Math.max(0, x)
                const endX = Math.min(LCD_WIDTH - 1, x + CHAR_WIDTH - 1)
                if (startX <= endX) {
                    const addr = SRAM.getPixelAddr(startX, py)
                    SRAM.beginStreamWrite(addr)
                    for (let col = 0; col < CHAR_WIDTH; col++) {
                        const px = x + col
                        if (px >= 0 && px < LCD_WIDTH) {
                            const pixelOn = (rowData & (0x80 >> col)) !== 0
                            const pixelColor = pixelOn ? color : bgColor
                            SRAM.streamWriteColor(pixelColor)
                        }
                    }
                    SRAM.endStream()
                }
            } else {
                // No background - only draw foreground pixels
                for (let col = 0; col < CHAR_WIDTH; col++) {
                    if (rowData & (0x80 >> col)) {
                        const px = x + col
                        if (px >= 0 && px < LCD_WIDTH) {
                            const addr = SRAM.getPixelAddr(px, py)
                            SRAM.writeColor(addr, color)
                        }
                    }
                }
            }
        }
    }
}

// Text drawing extension for Graphics namespace
namespace Graphics {
    //% blockId=gfx_draw_text
    //% block="draw text %text at x %x y %y color %color"
    //% x.min=0 x.max=159 y.min=0 y.max=127
    //% color.shadow=colorNumberPicker
    //% group="Text"
    //% weight=35
    export function drawText(text: string, x: number, y: number, color: number): void {
        let cursorX = x
        let cursorY = y

        for (let i = 0; i < text.length; i++) {
            const char = text.charAt(i)

            // Handle newline
            if (char === '\n') {
                cursorX = x
                cursorY += Font.CHAR_HEIGHT
                continue
            }

            // Word wrap
            if (cursorX + Font.CHAR_WIDTH > LCD_WIDTH) {
                cursorX = x
                cursorY += Font.CHAR_HEIGHT
            }

            // Stop if off screen vertically
            if (cursorY + Font.CHAR_HEIGHT > LCD_HEIGHT) break

            Font.drawChar(cursorX, cursorY, char, color)
            cursorX += Font.CHAR_WIDTH
        }
    }

    //% blockId=gfx_draw_text_bg
    //% block="draw text %text at x %x y %y color %color background %bgColor"
    //% x.min=0 x.max=159 y.min=0 y.max=127
    //% color.shadow=colorNumberPicker
    //% bgColor.shadow=colorNumberPicker
    //% group="Text"
    //% weight=34
    export function drawTextWithBackground(text: string, x: number, y: number, color: number, bgColor: number): void {
        let cursorX = x
        let cursorY = y

        for (let i = 0; i < text.length; i++) {
            const char = text.charAt(i)

            if (char === '\n') {
                cursorX = x
                cursorY += Font.CHAR_HEIGHT
                continue
            }

            if (cursorX + Font.CHAR_WIDTH > LCD_WIDTH) {
                cursorX = x
                cursorY += Font.CHAR_HEIGHT
            }

            if (cursorY + Font.CHAR_HEIGHT > LCD_HEIGHT) break

            Font.drawChar(cursorX, cursorY, char, color, bgColor)
            cursorX += Font.CHAR_WIDTH
        }
    }

    //% blockId=gfx_draw_number
    //% block="draw number %num at x %x y %y color %color"
    //% x.min=0 x.max=159 y.min=0 y.max=127
    //% color.shadow=colorNumberPicker
    //% group="Text"
    //% weight=33
    export function drawNumber(num: number, x: number, y: number, color: number): void {
        drawText(num.toString(), x, y, color)
    }
}

